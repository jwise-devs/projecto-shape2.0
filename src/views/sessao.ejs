<!DOCTYPE html>
<html lang="pt">
<%- include('includes/head') %>
<title>Sessão</title>

<body>
  <%- include('includes/navbar') %>
  <div class="container">
    <div class="row">
      <div class="col-lg-2"></div>

      <div class="col-lg-8 my-3">
        <h1 class="text-center">Sessão</h1>
        <p class="text-center lead">Preencha os seus dados</p>

        <%- include('includes/messeges') %>

        <form action="<%= user.role === 'desk' || user.role === 'admin' ? '/sessao/novo/data/' + usuarioId : '/sessao/data' %>" method="post">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">

          <!-- Usar Pacote -->
          <div class="container mt-4">
            <label for="usarPacoteSessao" class="form-label">Deseja escolher um pacote de sessão?</label>
            <select id="usarPacoteSessao" class="form-select" name="usarPacoteSessao">
              <option value="nao" selected>Não</option>
              <option value="sim">Sim</option>
            </select>
          </div>

          <!-- Selecionar Pacote -->
          <div class="container mt-4">
            <label for="pacote" class="form-label">Pacote</label>
            <select class="form-select" id="pacote" name="pacote" disabled>
              <option value="" disabled selected>Selecione um pacote</option>
              <% pacotes.forEach(pacote => { %>
                <option value="<%= pacote %>"><%= pacote %></option>
              <% }); %>
            </select>
          </div>

          <!-- Subpacote -->
          <div class="mb-3 d-none container mt-4" id="subpacote-container">
            <label for="subpacote" class="form-label">Subpacote</label>
            <select class="form-select" id="subpacote" name="subpacote">
              <option value="" disabled selected>Selecione um subpacote</option>
            </select>
          </div>

          <!-- Tratamentos do Pacote/Subpacote -->
          <div class="container mt-5 d-none" id="tratamentos-container">
            <label for="tratamentos" class="form-label">Tratamentos do Pacote/Subpacote</label>
            <select class="form-select" id="tratamentos" name="tratamentos[]" multiple disabled>
              <option value="" disabled>Selecione um pacote primeiro</option>
            </select>
            <div class="form-text">Segure CTRL (ou CMD) para selecionar vários.</div>
          </div>

          <!-- Tratamentos livres sempre disponíveis -->
          <div class="container mt-5" id="tratamentos-livres-container">
            <label for="tratamentosLivres" class="form-label">Tratamentos Livres</label>
            <select class="form-select" id="tratamentosLivres" name="tratamentosLivres[]" multiple>
              <% tratamentos.forEach(trat => { %>
                <option value="<%= trat.nome %>" data-preco="<%= trat.preco %>">
                  <%= trat.nome %> - R$ <%= parseFloat(trat.preco).toFixed(2) %>
                </option>
              <% }); %>
            </select>
            <div class="form-text">Você pode escolher tratamentos diretamente sem pacote.</div>
          </div>

          <!-- Data da consulta -->
          <div class="mb-3 my-3">
            <label class="form-label">Data e Hora de Consulta</label>
            <input type="datetime-local" class="form-control" name="data_hora_consulta" value="">
          </div>

          <!-- Preço e envio -->
          <input type="hidden" name="preco_tratamentos" id="preco_tratamentos">
          <p class="mt-3"><strong>Total: <span id="precoTotal">0.00</span> MT</strong></p>

          <div id="tratamentosData" data-tratamentos='<%= JSON.stringify(tratamentos) %>' style="display: none;"></div>

          <button type="submit" class="btn btn-primary my-3">Salvar</button>
          <% if(user && (user.role === 'desk' || user.role === 'admin')) { %>
            <a href="/clientes" class="btn btn-primary">Voltar</a>
          <% } %>
        </form>
      </div>

      <div class="col-lg-2"></div>
    </div>
  </div>

  <%- include('includes/script') %>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const usarPacoteSessao = document.getElementById("usarPacoteSessao");
      const categoriaSelect = document.getElementById("pacote");
      const subSelect = document.getElementById("subpacote");
      const subContainer = document.getElementById("subpacote-container");
      const tratamentosContainer = document.getElementById("tratamentos-container");
      const tratamentosLivresSelect = document.getElementById("tratamentosLivres");
      const tratamentosSelect = document.getElementById("tratamentos");
      const precoTotalText = document.getElementById("precoTotal");
      const precoInput = document.getElementById("preco_tratamentos");

      const tratamentosData = JSON.parse(document.getElementById("tratamentosData").dataset.tratamentos);
      const dados = {};

      tratamentosData.forEach(t => {
        if (!dados[t.pacote]) dados[t.pacote] = { produtos: [], subpacotes: {} };

        if (t.subpacote && t.subpacote !== "Nenhum subpacote") {
          if (!dados[t.pacote].subpacotes[t.subpacote]) dados[t.pacote].subpacotes[t.subpacote] = [];
          dados[t.pacote].subpacotes[t.subpacote].push({ text: t.nome, value: t.nome, preco: parseFloat(t.preco) });
        } else {
          dados[t.pacote].produtos.push({ text: t.nome, value: t.nome, preco: parseFloat(t.preco) });
        }
      });

      function atualizarTratamentos(tratamentos) {
        tratamentosSelect.innerHTML = "";
        tratamentos.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t.value;
          opt.textContent = `${t.text} - R$ ${t.preco.toFixed(2)}`;
          opt.dataset.preco = t.preco;
          tratamentosSelect.appendChild(opt);
        });
        tratamentosSelect.disabled = false;
      }

      function calcularTotal() {
        let total = 0;
        const precos = [];

        [...tratamentosSelect.selectedOptions, ...tratamentosLivresSelect.selectedOptions].forEach(opt => {
          const preco = parseFloat(opt.dataset.preco);
          if (!isNaN(preco)) {
            total += preco;
            precos.push(preco);
          }
        });

        precoTotalText.textContent = total.toFixed(2);
        precoInput.value = JSON.stringify(precos);
      }

      usarPacoteSessao.addEventListener("change", () => {
        const usar = usarPacoteSessao.value === "sim";

        if (usar) {
          categoriaSelect.disabled = false;
          tratamentosContainer.classList.remove("d-none");
        } else {
          categoriaSelect.value = "";
          categoriaSelect.disabled = true;
          subSelect.innerHTML = "";
          tratamentosSelect.innerHTML = "";
          tratamentosSelect.disabled = true;
          subContainer.classList.add("d-none");
          tratamentosContainer.classList.add("d-none");
        }

        calcularTotal();
      });

      categoriaSelect.addEventListener("change", () => {
        const pacote = categoriaSelect.value;
        const subpacotes = dados[pacote]?.subpacotes;
        const produtos = dados[pacote]?.produtos || [];

        subSelect.innerHTML = "";
        tratamentosSelect.innerHTML = "";

        if (subpacotes && Object.keys(subpacotes).length > 0) {
          subContainer.classList.remove("d-none");
          const opt = document.createElement("option");
          opt.value = "";
          opt.disabled = true;
          opt.selected = true;
          opt.textContent = "Selecione um subpacote";
          subSelect.appendChild(opt);

          Object.keys(subpacotes).forEach(sub => {
            const opt = document.createElement("option");
            opt.value = sub;
            opt.textContent = sub;
            subSelect.appendChild(opt);
          });

          subSelect.disabled = false;
        } else {
          subContainer.classList.add("d-none");
          subSelect.disabled = true;
          atualizarTratamentos(produtos);
        }
      });

      subSelect.addEventListener("change", () => {
        const pacote = categoriaSelect.value;
        const sub = subSelect.value;
        const tratamentos = dados[pacote]?.subpacotes[sub] || [];
        atualizarTratamentos(tratamentos);
      });

      tratamentosSelect.addEventListener("change", calcularTotal);
      tratamentosLivresSelect.addEventListener("change", calcularTotal);
    });
  </script>
</body>
</html>
